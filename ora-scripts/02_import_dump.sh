#!/bin/bash
# Corrige as permissões do diretório antes da importação
chown -R oracle /opt/oracle/dump
chmod -R 755 /opt/oracle/dump

# Script SQL para criar o diretório Oracle
sqlplus system/root@FREE <<EOF
CREATE OR REPLACE DIRECTORY DUMP_DIR AS '/opt/oracle/dump';
GRANT READ, WRITE ON DIRECTORY DUMP_DIR TO LPORTAL;
CREATE TABLESPACE LIFERAYDXP_DATA \
DATAFILE '/opt/oracle/oradata/LIFERAYDXP_DATA.dbf' SIZE 100M AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED \
EXTENT MANAGEMENT LOCAL;
CREATE TABLESPACE LIFERAYDXP_DATA DATAFILE '/opt/oracle/oradata/FREE/liferaydxp_data.dbf' SIZE 500M AUTOEXTEND ON;
CREATE TEMPORARY TABLESPACE TEMP TEMPFILE '/opt/oracle/oradata/FREE/temp.dbf' SIZE 100M AUTOEXTEND ON;
GRANT CREATE USER TO SYSTEM;
GRANT CREATE ANY TABLE TO SYSTEM;
GRANT CREATE ANY TABLESPACE TO SYSTEM;
GRANT CREATE ANY VIEW TO LPORTAL;
GRANT CREATE ANY PROCEDURE TO LPORTAL;
GRANT CREATE ANY JOB TO LPORTAL;
GRANT CREATE SESSION TO LPORTAL;
GRANT CREATE TABLE TO LPORTAL;
GRANT CREATE VIEW TO LPORTAL;
GRANT CREATE SEQUENCE TO LPORTAL;
GRANT CREATE PROCEDURE TO LPORTAL;
GRANT CREATE TRIGGER TO LPORTAL;
GRANT CREATE DATABASE LINK TO LPORTAL;
GRANT UNLIMITED TABLESPACE TO LPORTAL;
EXIT;
EOF

# Executa a importação do dump usando o impdp para o serviço FREE
impdp LPORTAL/root@FREE \
    DIRECTORY=DUMP_DIR \
    DUMPFILE=dump.dmp \
    LOGFILE=DUMP_DIR:import_lportal.log \
    REMAP_SCHEMA=LIFERAYDXP_ADMIN:LPORTAL \
    EXCLUDE=USER
